<section 
  *ngIf="activeTab === 'messages'" 
  class="animate-fade-in"
  role="region" 
  aria-labelledby="messages-title">
  
  <div class="flex bg-white rounded-2xl shadow-lg overflow-hidden min-h-[500px]">
    <!-- User List Sidebar -->
    <aside class="w-64 border-r bg-gradient-to-b from-blue-50 to-white p-6 flex flex-col" role="complementary" aria-label="Chat contacts">
      <header class="mb-6">
        <h3 id="messages-title" class="font-bold text-blue-700 text-lg tracking-tight">Chats</h3>
        <p class="text-sm text-gray-600 mt-1">{{ users.length }} contacts</p>
      </header>
      
      <nav class="flex-1">
        <ul class="space-y-2 overflow-y-auto" role="list">
          <li *ngFor="let user of users; trackBy: trackByUserId">
            <button
              type="button"
              (click)="selectUser(user)"
              [class.bg-blue-100]="selectedUser?.id === user.id"
              class="w-full p-3 rounded-xl cursor-pointer hover:bg-blue-50 flex items-center gap-3 transition-all duration-150 text-left"
              [attr.aria-pressed]="selectedUser?.id === user.id"
              [attr.aria-label]="'Chat with ' + user.name">
              <div class="w-10 h-10 rounded-full bg-blue-200 flex items-center justify-center text-blue-700 font-bold text-lg flex-shrink-0" aria-hidden="true">
                {{ user.name.charAt(0) }}
              </div>
              <div class="flex-1 min-w-0">
                <span class="font-medium text-gray-700 block truncate">{{ user.name }}</span>
                <span *ngIf="user.lastMessage" class="text-sm text-gray-500 block truncate">{{ user.lastMessage }}</span>
              </div>
              <div *ngIf="user.unreadCount" class="w-5 h-5 bg-red-500 text-white text-xs rounded-full flex items-center justify-center flex-shrink-0">
                {{ user.unreadCount > 9 ? '9+' : user.unreadCount }}
              </div>
            </button>
          </li>
        </ul>
      </nav>
    </aside>
    
    <!-- Chat Area -->
    <main class="flex-1 flex flex-col bg-white" role="main" aria-label="Chat conversation">
      <div *ngIf="selectedUser; else selectPrompt" class="flex-1 flex flex-col h-full">
        <!-- Chat Header -->
        <header class="border-b px-6 py-4 flex items-center gap-3 bg-blue-50">
          <div class="w-10 h-10 rounded-full bg-blue-200 flex items-center justify-center text-blue-700 font-bold text-lg flex-shrink-0" aria-hidden="true">
            {{ selectedUser.name.charAt(0) }}
          </div>
          <div class="flex-1">
            <h4 class="font-semibold text-blue-700 text-lg">{{ selectedUser.name }}</h4>
            <p class="text-sm text-blue-600">{{ selectedUser.status || 'Online' }}</p>
          </div>
          <div class="flex gap-2">
            <button 
              type="button"
              class="p-2 text-blue-600 hover:bg-blue-100 rounded-lg transition-colors"
              (click)="startVideoCall()"
              [attr.aria-label]="'Start video call with ' + selectedUser.name">
              ðŸ“¹
            </button>
            <button 
              type="button"
              class="p-2 text-blue-600 hover:bg-blue-100 rounded-lg transition-colors"
              (click)="startVoiceCall()"
              [attr.aria-label]="'Start voice call with ' + selectedUser.name">
              ðŸ“ž
            </button>
          </div>
        </header>
        
        <!-- Messages Container -->
        <div 
          class="flex-1 p-6 overflow-y-auto flex flex-col gap-3 bg-gradient-to-b from-white to-blue-50"
          role="log"
          aria-label="Chat messages"
          #messagesContainer>
          <div 
            *ngFor="let msg of chatMessages[selectedUser.id]; trackBy: trackByMessageId" 
            [ngClass]="{'self-end': msg.from === 'You', 'self-start': msg.from !== 'You'}"
            class="flex">
            <div 
              [ngClass]="msg.from === 'You' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-800'"
              class="inline-block px-4 py-3 rounded-2xl shadow max-w-xs break-words">
              <span class="block">{{ msg.text }}</span>
              <time class="block text-xs mt-2 opacity-70 text-right">{{ msg.time | date:'shortTime' }}</time>
            </div>
          </div>
        </div>
        
        <!-- Message Input -->
        <form 
          class="flex border-t p-4 gap-3 bg-white" 
          (ngSubmit)="sendMessage()"
          role="search">
          <div class="flex-1 relative">
            <input 
              type="text" 
              [(ngModel)]="newMessage" 
              name="message" 
              class="w-full border border-gray-200 rounded-full px-5 py-3 outline-none focus:ring-2 focus:ring-blue-200 focus:border-blue-400 transition-colors" 
              placeholder="Type a message..." 
              autocomplete="off"
              aria-label="Type your message"
              maxlength="1000"
              required />
            <div class="absolute right-3 top-1/2 transform -translate-y-1/2 text-xs text-gray-400">
              {{ newMessage.length || 0 }}/1000
            </div>
          </div>
          
          <button 
            type="submit" 
            class="bg-blue-600 text-white px-6 py-3 rounded-full font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex-shrink-0"
            [disabled]="!newMessage.trim()"
            aria-label="Send message">
            <span class="sr-only">Send</span>
            ðŸ“¤
          </button>
        </form>
      </div>
      
      <!-- No User Selected Prompt -->
      <ng-template #selectPrompt>
        <div class="flex-1 flex flex-col items-center justify-center text-gray-400">
          <div class="text-6xl mb-4">ðŸ’¬</div>
          <h4 class="text-xl mb-2">Select a contact to start chatting</h4>
          <p class="text-gray-400">Choose from your contacts list to begin a conversation</p>
        </div>
      </ng-template>
    </main>
  </div>
</section>